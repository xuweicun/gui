<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <!-- Mobile Metas -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

    <include file="PublicHeader" />
</head>
<body ng-app="user_module" ng-controller="user_controller as showCase">

    <div class="navbar" role="navigation">
        <div class="container-fluid container-nav">
            <!-- Navbar Action -->
            <ul class="nav navbar-nav navbar-actions navbar-left">
                <li class="visible-md visible-lg"><a href="#" id="main-menu-toggle"><i class="fa fa-th-large"></i></a></li>
                <li class="visible-xs visible-sm"><a href="#" id="sidebar-menu"><i class="fa fa-navicon"></i></a></li>
            </ul>
            <!-- Navbar Left -->
            <div class="navbar-left">
                <!-- Search Form -->
                <form class="search navbar-form" >
                    <div class="input-group input-search">
                        <input type="text" class="form-control bk-radius" name="key" id="q" placeholder="搜索...">
                        <span class="input-group-btn">
                            <button class="btn btn-default" type="submit"><i class="fa fa-search"></i></button>
                        </span>
                    </div>
                </form>
            </div>
            <!-- Navbar Right -->
            <div class="navbar-right">
                <div class="userbox">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <div class="profile-info">
                            <span class="name">您好，超级管理员<{$username}></span>
                            <span class="role">
                                <i class="fa fa-circle bk-fg-success"></i>
                                <span>用户管理权限</span>
                            </span>
                            <span id="username" style="display:none" ng-disabled="user.off_line"><{$username}></span>
                            <span id="userid" style="display:none" ng-disabled="user.off_line"><{$userid}></span>
                            <span id="can_write" style="display:none" ng-disabled="user.off_line"><{$can_write}></span>
                            <span id="token" style="display:none" ng-disabled="user.off_line"><{$token}></span>
                        </div>
                        <i class="fa custom-caret"></i>
                    </a>

                    <div class="dropdown-menu">
                        <ul class="list-unstyled">
                            <li class="dropdown-menu-header bk-bg-white bk-margin-top-15">
                                <div class="progress progress-xs  progress-striped active">
                                    <div class="progress-bar progress-bar-primary" role="progressbar" aria-valuenow="60"
                                         aria-valuemin="0" aria-valuemax="100" style="width: 60%;">
                                        60%
                                    </div>
                                </div>
                            </li>
                            <li>
                                <a href=""><i class="fa fa-user"></i> 管理员信息</a>
                            </li>
                            <li>
                                <a href=""><i class="fa fa-wrench"></i> 参数配置</a>
                            </li>

                            <li>
                                <a href="" ng-click="user_profile.showChangePasswordModal()"><i class="fa fa-usd"></i> 修改密码</a>
                            </li>

                            <li>
                                <a href="" ng-click="user_profile.show_logout_modal();"><i class="fa fa-power-off"></i> 注销</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- End Userbox -->
            </div>
            <!-- End Navbar Right -->
        </div>
    </div>
    <div class="container-fluid content">
        <div class="row">
            <div class="sidebar">
                <div class="sidebar-collapse">
                    <!-- Sidebar Header Logo-->
                    <div class="sidebar-header">
                        <img src="/Public/assets/img/hlsqlogo2.png" class="img-responsive" alt="" style="display: inline-block;width: 50%;" />
                    </div>
                    <!-- Sidebar Menu-->
                    <div class="sidebar-menu">
                        <nav id="menu" class="nav-main" role="navigation">
                            <div class="panel-body text-center">
                                <h4 style="color: white;">离线硬盘存储管理系统</h4>
                                <div class="flag" style="display: none;">
                                    <img src="/Public/assets/img/flags/cn.jpg" style="display: inline-block;width: 50%;" class="img-flags" alt="" />
                                </div>
                            </div>
                            <ul class="nav nav-sidebar">
                                <li>
                                    <a href="" ng-click="change_page_index('user_manage')">
                                        <i class="fa fa-users" aria-hidden="true"></i><span>用户管理</span>
                                    </a>
                                </li>
                                <li ng-class="{'active':page_index=='user_log'}">
                                    <a href="" ng-click="change_page_index('user_log');reload_user_log()">
                                        <i class="fa  fa-gears" aria-hidden="true"></i><span>操作日志</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="" ng-click="change_page_index('manul')">
                                        <i class="fa  fa-book" aria-hidden="true"></i><span>操作说明</span>
                                    </a>
                                </li>
                                <li>
                                    <a href="" ng-click="user_profile.show_logout_modal();">
                                        <i class="fa  fa-hand-o-left" aria-hidden="true"></i><span>退出</span>
                                    </a>
                                </li>

                            </ul>
                        </nav>
                    </div>
                    <!-- End Sidebar Menu-->
                </div>
            </div>
            <div class="main">
                <div>
                    <div class="content container-fluid bk-margin-10">
                        <div class="row">
                            <div class="panel panel-primary col-12">
                                <div class="panel-heading">
                                    <h4 class="panel-title">用户管理</h4>
                                </div>
                                <div class="panel-body bk-noradius">
                                    <div class="row bk-margin-10">
                                        <div class="col-12">
                                            <a href="" class="btn btn-primary" ng-click="user_add()">
                                                <i class="glyphicon glyphicon-plus-sign"></i>
                                                新增用户
                                            </a>
                                        </div>
                                    </div>


                                    <div class="table-responsive">
                                        <table class="table table-striped dataTable no-footer"
                                               datatable="ng" dt-options="showCase.dtOptions">
                                            <thead>
                                                <tr>
                                                    <td>序号</td>
                                                    <td>用户名</td>
                                                    <td>权限</td>
                                                    <td>编辑</td>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="user in users_model">
                                                    <td>{{$index+1}}</td>
                                                    <td>{{user.username}}</td>
                                                    <td>{{user.write != 0?'读/写':'只读'}}</td>
                                                    <td>
                                                        <a class="btn btn-info btn-xs" href="" ng-click="user_edit($index)">
                                                            <i class="fa fa-edit "></i> 权限
                                                        </a>
                                                        <a class="btn btn-info btn-xs" href="" ng-click="user_passwd_reset($index)">
                                                            <i class="glyphicon glyphicon-refresh"></i> 密码
                                                        </a>
                                                        <a href="" class="btn btn-danger btn-xs" ng-click="user_remove($index)">
                                                            <i class="glyphicon glyphicon-trash"></i>
                                                            删除
                                                        </a>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <include file="super-user-modals" />
</body>

</html>
<!-- Vendor JS-->
<script src="/Public/assets/vendor/js/jquery.min.js"></script>
<script src="/Public/assets/vendor/js/jquery-2.1.1.min.js"></script>
<script src="/Public/assets/vendor/js/jquery-migrate-1.2.1.min.js"></script>
<script src="/Public/assets/vendor/bootstrap/js/bootstrap.min.js"></script>
<script src="/Public/assets/plugins/jquery-validation/js/jquery.validate.js"></script>
<script src="/Public/assets/vendor/skycons/js/skycons.js"></script>
<script src="/Public/assets/vendor/js/pace.min.js"></script>

<!-- Plugins JS-->
<script src="/Public/assets/plugins/jquery-ui/js/jquery-ui-1.10.4.min.js"></script>
<script src="/Public/assets/plugins/scrollbar/js/jquery.mCustomScrollbar.concat.min.js"></script>
<script src="/Public/assets/plugins/bootkit/js/bootkit.js"></script>
<script src="/Public/assets/plugins/magnific-popup/js/magnific-popup.js"></script>
<script src="/Public/assets/plugins/moment/js/moment.min.js"></script>

<script src="/Public/assets/plugins/select2/select2.js"></script>
<script src="/Public/assets/plugins/jquery-datatables/media/js/jquery.dataTables.js"></script>
<!-- Theme JS -->
<script src="/Public/assets/js/jquery.mmenu.min.js"></script>
<script src="/Public/assets/js/core.min.js"></script>

<!-- Pages JS -->
<script src="/Public/assets/js/pages/ui-modals.js"></script>
<script src="/Public/assets/plugins/pnotify/js/pnotify.custom.js"></script>

<script src="/Public/js/md5.js"></script>
<script src="/Public/js/angular-1.4.min.js"></script>
<script src="/Public/js/angular-datatables.min.js"></script>
<script>
    var user_app = angular.module('user_module', ['datatables']);
    user_app.controller('user_controller', function($scope, $http, DTOptionsBuilder, DTDefaultOptions){
        var vm = this;
        vm.dtOptions = DTOptionsBuilder.newOptions().withPaginationType('full_numbers');
        DTDefaultOptions.setLanguage({
            "sProcessing": "处理中...",
            "sLengthMenu": "每页显示 _MENU_ 条",
            "sZeroRecords": "没有匹配的命令",
            "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
            "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
            "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
            "sInfoPostFix": "",
            "sUrl": "",
            "sEmptyTable": "没有账户",
            "sLoadingRecords": "载入中...",
            "sInfoThousands": ",",
            "oPaginate": {
                "sFirst": "首页",
                "sPrevious": "上页",
                "sNext": "下页",
                "sLast": "末页"
            },
            "oAria": {
                "sSortAscending": ": 以升序排列此列",
                "sSortDescending": ": 以降序排列此列"
            },
            "sSearch":'查找:'
        });

        $scope.user_add = function(){
            $scope.new_user = {username:'', password:''};

            $('#modalUserAdd').modal('show');
        }
        $scope.user_add_commit = function(){
            var username = $scope.new_user.username.trim();
            var password = $scope.new_user.password.trim();
            if (username == '' || password == ''){
                return;
            }

            $http({
                url:'/index.php?m=admin&c=business&a=user_add',
                method:'POST',
                data:{
                    username: username,
                    password: hex_md5(password)
                }
            }).success(function(data){
                console.log(data);
                $('#modalUserAdd').modal('hide');
                //响应成功
                try{
                    var rlt = JSON.parse(data);
                    if (rlt.status == 'success'){
                        $scope.reload_users();

                        new PNotify({
                            title: '新增用户',
                            text: '成功新增用户‘'+rlt.username+'’!',
                            type: 'success',
                            shadow: true,
                            icon: 'fa fa-check-o'
                        });
                    }
                    else{
                        new PNotify({
                            title: '新增用户',
                            text: '新增用户‘'+rlt.username+'’失败，曾经已使用过的用户名!',
                            type: 'error',
                            shadow: true,
                            icon: 'glyphicon glyphicon-remove-circle'
                        });
                    }
                }catch(err) {
                    console.log(222);
                }
                finally {
                }
            }).error(function(data){
                console.log(data);
                //处理响应失败
                $scope.users_model = undefined;
            });
        }
        $scope.user_edit = function(idx){
            $scope.curr_user_idx = idx;
            // 写权限复位
            $scope.can_write = $scope.users_model[idx].write;

            $('#modalUserEdit').modal('toggle');
        }
        $scope.user_edit_commit = function(){
            if ($scope.curr_user_idx == undefined) return;

            var usr = $scope.users_model[$scope.curr_user_idx];
            $http({
                url:'/index.php?m=admin&c=business&a=user_set_write',
                method:'POST',
                data:{
                    id: usr.id,
                    write: $scope.can_write
                }
            }).success(function(data){
                console.log(data);
                $('#modalUserEdit').modal('hide');
                //响应成功
                try{
                    var rlt = JSON.parse(data);
                    if (rlt.status == 'success'){
                        $scope.users_model[$scope.curr_user_idx].write = rlt.write;
                        new PNotify({
                            title: '修改权限',
                            text: '成功修改权限',
                            type: 'success',
                            shadow: true,
                            icon: 'fa fa-check-o'
                        });
                    }
                    else{
                        $('#modalUserEditFail').modal('toggle');
                    }
                }catch(err) {
                    console.log(222);
                }
                finally {
                    console.log(333);
                }
            }).error(function(data){
                console.log(data);
                //处理响应失败
                $scope.users_model = undefined;
            });
        }
        $scope.user_remove = function(idx){
            $scope.curr_user_idx = idx;
            $('#modalUserRemove').modal('toggle');
        }
        $scope.user_remove_commit = function(){
            var usr = $scope.users_model[$scope.curr_user_idx];
            $http({
                url:'/index.php?m=admin&c=business&a=user_remove',
                method:'POST',
                data:{
                    id: usr.id
                }
            }).success(function(data){
                console.log(data);
                $('#modalUserRemove').modal('hide');
                //响应成功
                try{
                    var rlt = JSON.parse(data);
                    if (rlt.status == 'success'){
                        $scope.reload_users();
                        new PNotify({
                            title: '删除用户',
                            text: '成功删除用户',
                            type: 'success',
                            shadow: true,
                            icon: 'fa fa-check-o'
                        });
                    }
                    else{
                        $('#modalUserEditFail').modal('toggle');
                    }
                }catch(err) {
                    console.log(222);
                }
                finally {
                }
            }).error(function(data){
                console.log(data);
            });
        }


        $scope.user_passwd_reset = function(idx){
            $scope.new_password = '';
            $scope.curr_user_idx = idx;

            $('#modalUserPasswd').modal('show');
        }
        $scope.user_password_reset_commit = function(){
            var password = $scope.new_password.trim();
            if (password == ''){
                return;
            }

            var usr = $scope.users_model[$scope.curr_user_idx];
            $http({
                url:'/index.php?m=admin&c=business&a=user_passwd_reset',
                method:'POST',
                data:{
                    id: usr.id,
                    password: hex_md5($scope.new_password)
                }
            }).success(function(data){
                console.log(data);
                $('#modalUserPasswd').modal('hide');
                //响应成功
                try{
                    var rlt = JSON.parse(data);
                    if (rlt.status == 'success'){
                        new PNotify({
                            title: '重置密码',
                            text: '成功重置用户密码',
                            type: 'success',
                            shadow: true,
                            icon: 'fa fa-check-o'
                        });
                    }
                    else{
                        $('#modalUserEditFail').modal('toggle');
                    }
                }catch(err) {
                    console.log(222);
                }
                finally {
                }
            }).error(function(data){
                console.log(data);
            });
        }

        $scope.reload_users = function(){
            $http({
                url:'/index.php?m=admin&c=business&a=get_users',
                method:'GET'
            }).success(function(data,header,config,status){
                //响应成功
                $scope.users_model = data;
            }).error(function(data,header,config,status){
                //处理响应失败
                $scope.users_model = undefined;
            });
        }

        $scope.reload_users();
    });
</script>